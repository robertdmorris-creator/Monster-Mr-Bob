<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Bob's Monster Tag</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #FF5733;
            font-size: 16px;
        }
        #game-over-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FF5733;
            text-align: center;
            display: none;
            z-index: 10;
            font-size: 6vw; /* Responsive font size */
            text-shadow: 4px 4px 0px #000;
        }
        .label {
            color: white;
            background-color: transparent;
            font-family: 'Press Start 2P', cursive;
        }
        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #start-button {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #FF5733;
            color: white;
            border: 4px solid white;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 0 20px #FF5733;
        }
        #start-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="ui-container">
        Students Left: <span id="student-count">0</span>
    </div>
    <div id="game-over-message">Mr Bob: 1 Students 0</div>

    <div id="start-overlay">
        <button id="start-button">START GAME</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- Basic Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('game-container').appendChild(renderer.domElement);

        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        document.body.appendChild(labelRenderer.domElement);
        
        // --- Sound Setup ---
        let soundInitialized = false;
        let failSynth; // <-- UPDATED: Renamed for clarity

        const roarSynth = new Tone.AMSynth({
            harmonicity: 1.2,
            detune: 0,
            oscillator: { type: "fatsawtooth", count: 3, spread: 20 },
            envelope: { attack: 0.2, decay: 0.3, sustain: 0.4, release: 1.5 },
            modulation: { type: "square" },
            modulationEnvelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.5 }
        }).toDestination();
        roarSynth.volume.value = -3;
        
        // --- UPDATED: Sound initialization with synthesized fail sound ---
        const startOverlay = document.getElementById('start-overlay');
        const startButton = document.getElementById('start-button');

        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            startButton.textContent = "LOADING...";

            await Tone.start(); 
            
            // Create the synth for the fail sound
            failSynth = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
            }).toDestination();
            failSynth.volume.value = -10;

            soundInitialized = true; 
            startOverlay.style.display = 'none'; 
            animate();
        });

        // --- Skybox ---
        const loader = new THREE.CubeTextureLoader();
        const texture = loader.load([
            'https://threejsfundamentals.org/threejs/resources/images/cubemaps/skybox/right.png', 'https://threejsfundamentals.org/threejs/resources/images/cubemaps/skybox/left.png',
            'https://threejsfundamentals.org/threejs/resources/images/cubemaps/skybox/top.png', 'https://threejsfundamentals.org/threejs/resources/images/cubemaps/skybox/bottom.png',
            'https://threejsfundamentals.org/threejs/resources/images/cubemaps/skybox/front.png', 'https://threejsfundamentals.org/threejs/resources/images/cubemaps/skybox/back.png',
        ]);
        scene.background = texture;
        
        camera.position.set(0, 15, 25);

        // --- Lighting ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
        directionalLight.position.set(10, 20, 5);
        scene.add(directionalLight);

        // --- Ground & City Layout ---
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshLambertMaterial({ color: 0x228B22 }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);
        
        const cityLayout = new THREE.Group();
        const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x404040 });
        const sidewalkMaterial = new THREE.MeshLambertMaterial({ color: 0xAAAAAA });
        const roadWidth = 10, sidewalkWidth = roadWidth + 4, worldSize = 200, roadGridStep = 40;
        const roadPositions = [];

        for (let i = -worldSize / 2 + roadGridStep / 2; i < worldSize / 2; i += roadGridStep) {
            roadPositions.push({ x: i, z: 0, dir: 'z' });
            const sidewalk = new THREE.Mesh(new THREE.PlaneGeometry(sidewalkWidth, worldSize), sidewalkMaterial);
            sidewalk.rotation.x = -Math.PI / 2;
            sidewalk.position.set(i, 0.01, 0);
            cityLayout.add(sidewalk);
            const road = new THREE.Mesh(new THREE.PlaneGeometry(roadWidth, worldSize), roadMaterial);
            road.rotation.x = -Math.PI / 2;
            road.position.set(i, 0.02, 0);
            cityLayout.add(road);
        }
        for (let i = -worldSize / 2 + roadGridStep / 2; i < worldSize / 2; i += roadGridStep) {
            roadPositions.push({ x: 0, z: i, dir: 'x' });
            const sidewalk = new THREE.Mesh(new THREE.PlaneGeometry(worldSize, sidewalkWidth), sidewalkMaterial);
            sidewalk.rotation.x = -Math.PI / 2;
            sidewalk.position.set(0, 0.01, i);
            cityLayout.add(sidewalk);
            const road = new THREE.Mesh(new THREE.PlaneGeometry(worldSize, roadWidth), roadMaterial);
            road.rotation.x = -Math.PI / 2;
            road.position.set(0, 0.02, i);
            cityLayout.add(road);
        }
        scene.add(cityLayout);

        // --- Mr. Bob (Player) ---
        const mrBob = new THREE.Group();
        const monsterBodyMaterial = new THREE.MeshPhongMaterial({ color: 0x8B0000 });
        const body = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 16), monsterBodyMaterial);
        body.position.y = 1;
        mrBob.add(body);
        const eye = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshPhongMaterial({ color: 0xFFFF00 }));
        eye.position.set(-0.4, 1.2, 0.8);
        mrBob.add(eye);
        mrBob.add(eye.clone().translateX(0.8));
        const horn = new THREE.Mesh(new THREE.ConeGeometry(0.3, 1, 16), monsterBodyMaterial);
        horn.position.set(-0.5, 1.8, 0);
        horn.rotation.z = -0.3;
        mrBob.add(horn);
        mrBob.add(horn.clone().translateX(1).rotateZ(0.6));
        scene.add(mrBob);

        const bobDiv = document.createElement('div');
        bobDiv.className = 'label';
        bobDiv.textContent = 'Mr. Bob';
        const bobLabel = new CSS2DObject(bobDiv);
        bobLabel.position.set(0, 2.5, 0);
        mrBob.add(bobLabel);

        // --- Buildings ---
        const buildings = new THREE.Group();
        const buildingGeo = new THREE.BoxGeometry(1, 1, 1);
        function createBuildingTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 128;
            const context = canvas.getContext('2d');
            context.fillStyle = '#c2c2c2'; // Building color
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = '#6699ff'; // Window color
            const windowWidth = 10, windowHeight = 10, xSpacing = 8, ySpacing = 12;
            for (let y = ySpacing/2; y < canvas.height - windowHeight; y += windowHeight + ySpacing) {
                for (let x = xSpacing/2; x < canvas.width - windowWidth; x += windowWidth + xSpacing) {
                    context.fillRect(x, y, windowWidth, windowHeight);
                }
            }
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            return texture;
        }
        
        for (let i = 0; i < 150; i++) {
            const buildingMaterial = new THREE.MeshLambertMaterial({ map: createBuildingTexture() });
            const building = new THREE.Mesh(buildingGeo, buildingMaterial);
            const blockX = Math.floor(Math.random() * (worldSize / roadGridStep)) - (worldSize / roadGridStep / 2);
            const blockZ = Math.floor(Math.random() * (worldSize / roadGridStep)) - (worldSize / roadGridStep / 2);
            building.position.x = blockX * roadGridStep + (Math.random() - 0.5) * (roadGridStep - sidewalkWidth - 5);
            building.position.z = blockZ * roadGridStep + (Math.random() - 0.5) * (roadGridStep - sidewalkWidth - 5);
            building.scale.set(Math.random() * 6 + 4, Math.random() * 25 + 10, Math.random() * 6 + 4);
            building.position.y = building.scale.y / 2;
            building.material.map.repeat.set(Math.floor(building.scale.x / 4), Math.floor(building.scale.y / 4));
            buildings.add(building);
        }
        scene.add(buildings);

        // --- Cars ---
        const cars = new THREE.Group();
        function createVehicle() {
            const vehicle = new THREE.Group();
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: Math.random() * 0xffffff });
            const topMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
            const wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x111111 });
            let mainBody;

            const vehicleType = Math.random();
            if (vehicleType < 0.6) { // Car
                mainBody = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 2), bodyMaterial);
                vehicle.add(mainBody);
                const top = new THREE.Mesh(new THREE.BoxGeometry(2.5, 1, 1.8), topMaterial);
                top.position.y = 1.25;
                vehicle.add(top);
                vehicle.position.y = 0.75;
            } else if (vehicleType < 0.85) { // Pickup Truck
                mainBody = new THREE.Mesh(new THREE.BoxGeometry(5, 1.6, 2.1), bodyMaterial);
                vehicle.add(mainBody);
                const cab = new THREE.Mesh(new THREE.BoxGeometry(2, 1.2, 1.9), topMaterial);
                cab.position.set(-1, 1.4, 0);
                vehicle.add(cab);
                vehicle.position.y = 0.8;
            } else { // Box Truck
                const cab = new THREE.Mesh(new THREE.BoxGeometry(2.2, 2.2, 2.2), bodyMaterial);
                cab.position.x = 3;
                vehicle.add(cab);
                mainBody = new THREE.Mesh(new THREE.BoxGeometry(6, 2.8, 2.2), topMaterial);
                mainBody.position.x = -1;
                vehicle.add(mainBody);
                vehicle.position.y = 1.4;
            }
            
            const wheelGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.5, 32);
            const wheel1 = new THREE.Mesh(wheelGeo, wheelMaterial);
            wheel1.rotation.z = Math.PI / 2;
            wheel1.position.set(-mainBody.geometry.parameters.width / 2 + 0.5, -mainBody.geometry.parameters.height/2, 1.2);
            vehicle.add(wheel1);
            const wheel2 = wheel1.clone();
            wheel2.position.x = mainBody.geometry.parameters.width / 2 - 0.5;
            vehicle.add(wheel2);
            const wheel3 = wheel1.clone();
            wheel3.position.z = -1.2;
            vehicle.add(wheel3);
            const wheel4 = wheel2.clone();
            wheel4.position.z = -1.2;
            vehicle.add(wheel4);
            return vehicle;
        }

        roadPositions.forEach(roadPos => {
            for (let i = 0; i < 2; i++) {
                const vehicle1 = createVehicle();
                const vehicle2 = createVehicle();
                if (roadPos.dir === 'z') {
                    vehicle1.position.x = roadPos.x - roadWidth / 4;
                    vehicle1.position.z = (Math.random() - 0.5) * worldSize;
                    vehicle1.rotation.y = Math.PI / 2;
                    vehicle2.position.x = roadPos.x + roadWidth / 4;
                    vehicle2.position.z = (Math.random() - 0.5) * worldSize;
                    vehicle2.rotation.y = -Math.PI / 2;
                } else {
                    vehicle1.position.x = (Math.random() - 0.5) * worldSize;
                    vehicle1.position.z = roadPos.z - roadWidth / 4;
                    vehicle2.position.x = (Math.random() - 0.5) * worldSize;
                    vehicle2.position.z = roadPos.z + roadWidth / 4;
                    vehicle2.rotation.y = Math.PI;
                }
                cars.add(vehicle1);
                cars.add(vehicle2);
            }
        });
        scene.add(cars);
        
        // --- Students ---
        const students = new THREE.Group();
        const studentNames = ["Avery", "Sunnie", "Kylie", "Chloe", "Rylee", "Liam", "Kamden", "Steven", "Candice", "Arya", "Raelyn"];
        
        function createStudent(name) {
            const student = new THREE.Group();
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), new THREE.MeshPhongMaterial({ color: 0xFFDBAC }));
            head.position.y = 1.5;
            student.add(head);
            const sBody = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.6, 16), new THREE.MeshPhongMaterial({ color: Math.random() * 0xffffff }));
            sBody.position.y = 1;
            student.add(sBody);
            const pants = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.6, 16), new THREE.MeshPhongMaterial({ color: Math.random() * 0xffffff }));
            pants.position.y = 0.4;
            student.add(pants);

            const roadPos = roadPositions[Math.floor(Math.random() * roadPositions.length)];
            const side = Math.random() > 0.5 ? 1 : -1;
            const sidewalkOffset = roadWidth / 2 + 1;

            if (roadPos.dir === 'z') {
                student.position.x = roadPos.x + side * sidewalkOffset;
                student.position.z = (Math.random() - 0.5) * worldSize;
            } else {
                student.position.x = (Math.random() - 0.5) * worldSize;
                student.position.z = roadPos.z + side * sidewalkOffset;
            }

            const nameDiv = document.createElement('div');
            nameDiv.textContent = name;
            nameDiv.style.color = 'lightblue';
            nameDiv.style.fontSize = '16px';
            nameDiv.style.fontWeight = 'bold';
            nameDiv.style.fontFamily = 'sans-serif';
            nameDiv.style.textShadow = '1px 1px 2px black';
            const nameLabel = new CSS2DObject(nameDiv);
            nameLabel.position.set(0, 2, 0);
            student.add(nameLabel);
            student.userData.velocity = new THREE.Vector3((Math.random() - 0.5) * 0.03, 0, (Math.random() - 0.5) * 0.03);
            return student;
        }

        studentNames.forEach(name => students.add(createStudent(name)));
        scene.add(students);

        // --- Game State, Controls & Collision ---
        let keys = {}, gameOver = false;
        const studentCountElement = document.getElementById('student-count');
        studentCountElement.textContent = students.children.length;
        const obstacles = [...buildings.children, ...cars.children];
        const playerCollider = new THREE.Sphere(new THREE.Vector3(), 1.2);
        const playerVelocity = new THREE.Vector3();

        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        function moveMrBob() {
            if (gameOver) return;
            const speed = 0.18, rotationSpeed = 0.04;

            if (keys['KeyA'] || keys['ArrowLeft']) mrBob.rotation.y += rotationSpeed;
            if (keys['KeyD'] || keys['ArrowRight']) mrBob.rotation.y -= rotationSpeed;

            const moveDirection = new THREE.Vector3();
            if (keys['KeyW'] || keys['ArrowUp']) moveDirection.z = -1;
            if (keys['KeyS'] || keys['ArrowDown']) moveDirection.z = 1;
            
            playerVelocity.set(0, 0, 0);
            if (moveDirection.lengthSq() > 0) {
                playerVelocity.copy(moveDirection).applyQuaternion(mrBob.quaternion).setLength(speed);
            }

            mrBob.position.add(playerVelocity);

            playerCollider.center.copy(mrBob.position);
            for (const obstacle of obstacles) {
                const obstacleBox = new THREE.Box3().setFromObject(obstacle);
                if (playerCollider.intersectsBox(obstacleBox)) {
                    const closestPoint = new THREE.Vector3();
                    obstacleBox.clampPoint(playerCollider.center, closestPoint);
                    
                    const normal = playerCollider.center.clone().sub(closestPoint).normalize();
                    const penetrationDepth = playerCollider.radius - playerCollider.center.distanceTo(closestPoint);
                    
                    mrBob.position.add(normal.clone().multiplyScalar(penetrationDepth));
                    
                    const velocityProjection = playerVelocity.dot(normal);
                    if (velocityProjection < 0) {
                        playerVelocity.add(normal.clone().multiplyScalar(-velocityProjection));
                    }
                }
            }
        }

        function updateCamera() {
            const offset = new THREE.Vector3(0, 8, 15);
            const cameraPosition = offset.applyMatrix4(mrBob.matrixWorld);
            camera.position.lerp(cameraPosition, 0.1);
            camera.lookAt(mrBob.position);
        }

        function checkStudentTag() {
            if (gameOver) return;
            playerCollider.center.copy(mrBob.position);
            for (let i = students.children.length - 1; i >= 0; i--) {
                const student = students.children[i];
                const studentBox = new THREE.Box3().setFromObject(student);
                if (playerCollider.intersectsBox(studentBox)) {
                    if (soundInitialized && failSynth) {
                        // Play a two-note descending sound for the fail effect
                        const now = Tone.now();
                        failSynth.triggerAttackRelease("A#2", "8n", now);
                        failSynth.triggerAttackRelease("A2", "8n", now + 0.15);
                    }
                    students.remove(student);
                    studentCountElement.textContent = students.children.length;
                    if (students.children.length === 0) endGame();
                }
            }
        }
        
        function moveStudents() {
            students.children.forEach(student => {
                const oldPosition = student.position.clone();
                student.position.add(student.userData.velocity);
                const studentBox = new THREE.Box3().setFromObject(student);

                for (const obstacle of obstacles) {
                    const obstacleBox = new THREE.Box3().setFromObject(obstacle);
                    if (studentBox.intersectsBox(obstacleBox)) {
                        student.position.copy(oldPosition);
                        student.userData.velocity.negate();
                        break;
                    }
                }

                if (Math.abs(student.position.x) > 98 || Math.abs(student.position.z) > 98) {
                    student.position.copy(oldPosition);
                    student.userData.velocity.negate();
                }
            });
        }

        function endGame() {
            gameOver = true;
            document.getElementById('game-over-message').style.display = 'block';
            if (soundInitialized) roarSynth.triggerAttackRelease("G1", "2s");
        }

        function animate() {
            if (!soundInitialized) return; 
            requestAnimationFrame(animate);
            moveMrBob();
            moveStudents();
            updateCamera();
            checkStudentTag();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initial render to show something before starting
        renderer.render(scene, camera);
        labelRenderer.render(scene, camera);

    </script>
</body>
</html>
